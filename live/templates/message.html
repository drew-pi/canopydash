<html>
  <head>
    <title>Message Generator</title>
  </head>
  <body>
    <input id="message" type="text" />
    <progress id="progress" max="100" value="0"></progress>
    <p id="status">Waiting ...</p>
    <button id="submit-btn" onclick="submitMessage()">Submit</button>

    <script>
      async function submitMessage() {
        const msg = document.getElementById("message").value;

        console.log("Starting the task");
        console.log(`Running on ${window.location.host}`);

        // Disable UI while running
        const btn = document.getElementById("submit-btn");
        btn.disabled = true;

        try {
          const res = await fetch(
            `/live/api/message/?msg=${encodeURIComponent(msg)}`
          );
          const { task_id } = await res.json();

          const ws = new WebSocket(
            `ws://${location.host}/ws/progress/${task_id}/`
          );

          // Handle incoming progress updates
          ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            console.log("Received update:", data);

            document.getElementById("status").innerText = data.status;
            document.getElementById("progress").value = data.progress;

            if (data.status === "Done" && data.progress === 100) {
              ws.close();
              // Trigger download
              window.location = `/live/api/download/${task_id}/`;
            }
          };

          // Optional: handle unexpected closure
          ws.onclose = () => {
            console.log("WebSocket closed");

            // clean up the progress bar
            document.getElementById("progress").value = 0;
            document.getElementById("status").innerText = "Task complete";

            btn.disabled = false;
          };

          ws.onerror = (err) => {
            console.error("WebSocket error:", err);
            btn.disabled = false;
          };
        } catch (err) {
          console.error("Error submitting message:", err);
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
